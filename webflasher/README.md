# Nautilus WebUSB Flasher

A browser-based ESP32-S3 firmware flasher for the Nautilus device. No drivers or software installation required!

## Features

- ðŸŒ **Browser-based**: Flash firmware directly from your web browser
- ðŸ”Œ **No drivers needed**: Uses WebSerial API (built into modern browsers)
- ðŸ“¦ **Automatic**: Handles bootloader, partitions, and firmware automatically
- ðŸŽ¯ **Simple**: One-click flashing with real-time progress
- ðŸ”’ **Safe**: Includes erase and verify operations

## Requirements

### Browser
- Chrome 89+ (recommended)
- Edge 89+
- Opera 75+
- Any Chromium-based browser with WebSerial API support

**Note**: Firefox and Safari do not support WebSerial API.

### Device
- Nautilus device (ESP32-S3 based)
- USB-C cable for connection

## Usage

### 1. Build Firmware

First, build the firmware using PlatformIO. The build script will automatically copy the necessary files to the `webflasher/firmware` directory:

```bash
pio run
```

This will generate:
- `bootloader.bin` - ESP32-S3 bootloader
- `partitions.bin` - Partition table
- `firmware.bin` - Main application firmware
- `nautilus.bin` - Merged binary for single-file flashers (ESP32 Launcher, etc.)
- `manifest.json` - Flash addresses and metadata

### 2. Serve the Web Flasher

You need to serve the webflasher directory over HTTP(S). You can use any web server:

#### Option A: Python HTTP Server
```bash
cd webflasher
python3 -m http.server 8000
```

Then open: http://localhost:8000

#### Option B: Node.js HTTP Server
```bash
cd webflasher
npx http-server -p 8000
```

Then open: http://localhost:8000

#### Option C: VS Code Live Server
- Install "Live Server" extension in VS Code
- Right-click on `index.html` and select "Open with Live Server"

### 3. Put Device in Bootloader Mode

1. **Hold BOOT button** on the Nautilus device
2. **Press and release RESET button** while holding BOOT
3. **Release BOOT button**
4. The device is now in bootloader mode

### 4. Flash Firmware

1. Open the web flasher in your browser
2. Click **"Connect Device"**
3. Select your Nautilus device from the serial port list
4. Click **"Flash Firmware"**
5. Wait for the process to complete (usually 30-60 seconds)
6. Device will automatically reboot with new firmware

## File Structure

```
webflasher/
â”œâ”€â”€ index.html          # Main flasher interface
â”œâ”€â”€ flasher.js          # Flashing logic (uses esptool-js)
â”œâ”€â”€ README.md           # This file
â””â”€â”€ firmware/           # Auto-generated by build script
    â”œâ”€â”€ bootloader.bin  # ESP32-S3 bootloader (0x0)
    â”œâ”€â”€ partitions.bin  # Partition table (0x8000)
    â”œâ”€â”€ firmware.bin    # Application firmware (0x10000)
    â”œâ”€â”€ nautilus.bin    # Merged binary (all-in-one)
    â””â”€â”€ manifest.json   # Flash configuration
```

## Flash Memory Layout

The flasher writes firmware to these addresses:

| File | Address | Description |
|------|---------|-------------|
| bootloader.bin | 0x0 | ESP32-S3 bootloader |
| partitions.bin | 0x8000 | Partition table |
| firmware.bin | 0x10000 | Main application |

## Troubleshooting

### "WebSerial API not supported"
- Use a Chromium-based browser (Chrome, Edge, Opera)
- Update your browser to the latest version

### "No compatible devices found"
- Make sure device is in bootloader mode
- Check USB cable (must support data, not just charging)
- Try a different USB port
- On Linux, you may need to add udev rules for device permissions

### Flash fails or hangs
- Put device back in bootloader mode
- Try the "Erase Flash" button first, then flash again
- Check that all firmware files exist in `webflasher/firmware/`
- Try a lower baud rate (modify `flasher.js` if needed)

### Linux Permissions
If you get permission errors on Linux, create a udev rule:

```bash
sudo tee /etc/udev/rules.d/99-nautilus.rules > /dev/null <<EOF
SUBSYSTEM=="usb", ATTR{idVendor}=="239a", ATTR{idProduct}=="811b", MODE="0666"
SUBSYSTEM=="usb", ATTR{idVendor}=="239a", ATTR{idProduct}=="011b", MODE="0666"
SUBSYSTEM=="usb", ATTR{idVendor}=="239a", ATTR{idProduct}=="811c", MODE="0666"
EOF

sudo udevadm control --reload-rules
sudo udevadm trigger
```

## Advanced Usage

### Single-File Flashing (ESP32 Launcher, etc.)

For tools that require a single merged binary file (like ESP32 Launcher, Flash Download Tool, etc.), use `nautilus.bin`:

```bash
# Using esptool.py
esptool.py --chip esp32s3 write_flash 0x0 nautilus.bin

# Using ESP32 Flash Download Tool
# Simply load nautilus.bin at address 0x0
```

The merged binary contains:
- Bootloader at 0x0
- Partition table at 0x8000
- Firmware at 0x10000
- All gaps filled appropriately for 16MB flash

**Note**: `nautilus.bin` is automatically generated during the build process if `esptool.py` is installed.

### Custom Firmware Files

You can manually place firmware files in the `webflasher/firmware/` directory and update the `manifest.json` to flash custom builds.

### Erase Flash

Use the "Erase Flash" button to completely wipe the device. This is useful for:
- Cleaning up corrupted flash
- Starting fresh before flashing
- Removing all stored data

## Technical Details

- Uses [esptool-js](https://github.com/espressif/esptool-js) for ESP32 communication
- WebSerial API for browser-to-device serial communication
- Supports compression for faster flashing
- Automatic MD5 verification of flashed data
- Hard reset after successful flash

## Security Notes

- The web flasher runs entirely in your browser
- No data is sent to external servers
- Firmware files are loaded from the local server
- Requires explicit user permission to access serial port

## Support

For issues related to:
- **Nautilus device**: Check the main repository
- **Web flasher**: Open an issue with browser version and error logs
- **WebSerial API**: Check [caniuse.com/web-serial](https://caniuse.com/web-serial)

## License

Same as the main Nautilus project.
